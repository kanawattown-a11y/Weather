<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>لوحة طقس السويداء المتكاملة</title>
  <!-- Mapbox CSS -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: sans-serif; margin:0; padding:0; background:#f0f2f5; }
    .container { max-width: 900px; margin:20px auto; background:white; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.1); overflow:hidden; }
    header { padding:20px; background:#4a90e2; color:white; }
    header h1 { margin:0; font-size:1.5rem; }
    .tabs { display:flex; background:#eee; }
    .tabs button { flex:1; padding:10px; border:none; background:none; cursor:pointer; }
    .tabs button.active { background:white; font-weight:bold; }
    .tab-content { padding:20px; display:none; }
    .tab-content.active { display:block; }
    /* جزء Current */
    .current { text-align:center; }
    .current h2 { margin:10px 0; }
    .current .details { display:flex; justify-content:center; gap:20px; margin-top:10px; }
    .details div { text-align:center; }
    /* خريطة */
    #map { width:100%; height:300px; border-radius:6px; }
    /* رسم بياني ساعٍ */
    #hourlyChart { width:100%; height:200px; }
    /* بطاقات يومية */
    .daily { display:flex; gap:10px; overflow-x:auto; padding-bottom:10px; }
    .card { background:#fafafa; padding:10px; border-radius:6px; text-align:center; min-width:100px; }
  </style>
</head>
<body>

<div class="container">
  <header>
    <h1>طقس السويداء المتكامل</h1>
    <p id="updatedAt" style="font-size:0.9rem; opacity:0.8;">...</p>
  </header>

  <!-- تبويبات -->
  <div class="tabs">
    <button class="active" data-tab="current">الحالي</button>
    <button data-tab="hourly">ساعياً</button>
    <button data-tab="daily">يومياً</button>
    <button data-tab="map">خريطة</button>
  </div>

  <!-- المحتويات -->
  <div id="current" class="tab-content active">
    <div class="current">
      <h2 id="tempNow">--°C</h2>
      <p id="descNow">--</p>
      <div class="details">
        <div><strong id="humNow">--%</strong><br>رطوبة</div>
        <div><strong id="windNow">--</strong><br>رياح (كم/س)</div>
        <div><strong id="rainNow">--</strong><br>هطول مم</div>
      </div>
    </div>
  </div>

  <div id="hourly" class="tab-content">
    <canvas id="hourlyChart"></canvas>
  </div>

  <div id="daily" class="tab-content">
    <div class="daily" id="dailyCards"></div>
  </div>

  <div id="map" class="tab-content">
    <div id="mapboxContainer" style="position:relative;">
      <!-- زر إعادة -->
      <div id="style-switcher" style="position:absolute; top:10px; right:10px; z-index:2;">
        <button onclick="changeStyle('streets')">شوارع</button>
        <button onclick="changeStyle('satellite')">أقمار</button>
        <button onclick="changeStyle('outdoors')">تضاريس</button>
      </div>
      <div id="map"></div>
    </div>
  </div>
</div>

<!-- Mapbox JS -->
<script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
<script>
  const tomorrowKey = 'qtcXEQ29y3U0wLYRWS5cAekT1Bwv4UT8';
  const mapboxToken = 'pk.eyJ1Ijoia2FuYXdhdHRvd24iLCJhIjoiY21kdTI2dGl0MDdibjJxc2RhM3NueXZxZCJ9.uO1pbEZoyzPPHp7LOFffBA';
  const lat = 32.7092, lon = 36.5663;

  // تبديل تبويبات
  document.querySelectorAll('.tabs button').forEach(btn => {
    btn.onclick = () => {
      document.querySelectorAll('.tabs button, .tab-content').forEach(el => el.classList.remove('active'));
      btn.classList.add('active');
      document.getElementById(btn.dataset.tab).classList.add('active');
    };
  });

  async function loadWeather() {
    const url = `https://api.tomorrow.io/v4/timelines?location=${lat},${lon}`
      + `&fields=temperature,humidity,windSpeed,precipitationIntensity,weatherCode`
      + `&timesteps=current,next6h,next1d&units=metric&apikey=${tomorrowKey}`;
    const res = await fetch(url);
    const json = await res.json();
    const now = json.data.timelines[0].intervals[0].values;
    const hourly = json.data.timelines[1].intervals.slice(0,12);
    const daily = json.data.timelines[2].intervals.slice(0,7);

    // Current
    document.getElementById('tempNow').textContent = now.temperature.toFixed(1)+'°C';
    document.getElementById('descNow').textContent = now.weatherCode;
    document.getElementById('humNow').textContent = now.humidity+'%';
    document.getElementById('windNow').textContent = now.windSpeed+' كم/س';
    document.getElementById('rainNow').textContent = now.precipitationIntensity+' مم';
    document.getElementById('updatedAt').textContent = 'آخر تحديث: '+new Date().toLocaleTimeString('ar-EG');

    // Hourly Chart
    const ctx = document.getElementById('hourlyChart').getContext('2d');
    new Chart(ctx, {
      type: 'line',
      data: {
        labels: hourly.map(i=> new Date(i.startTime).getHours()+':00'),
        datasets: [{ label:'°C', data: hourly.map(i=>i.values.temperature), fill:true }]
      },
      options:{ scales:{ y:{ beginAtZero:false } } }
    });

    // Daily Cards
    const dailyDiv = document.getElementById('dailyCards');
    daily.forEach(d => {
      const date = new Date(d.startTime);
      const card = document.createElement('div'); card.className='card';
      card.innerHTML = `<strong>${date.toLocaleDateString('ar-EG',{weekday:'short',day:'numeric'})}</strong>
        <p>${d.values.temperature.toFixed(1)}°C</p>
        <p>هطول:${d.values.precipitationIntensity.toFixed(1)}مم</p>`;
      dailyDiv.append(card);
    });

    // خريطة Mapbox
    mapboxgl.accessToken = mapboxToken;
    window.map = new mapboxgl.Map({
      container:'map', style:'mapbox://styles/mapbox/streets-v11',
      center:[lon,lat], zoom:10
    });
    map.addControl(new mapboxgl.NavigationControl());
    new mapboxgl.Marker()
      .setLngLat([lon,lat])
      .setPopup(new mapboxgl.Popup().setText(
        `درجة الحرارة: ${now.temperature.toFixed(1)}°C\nرطوبة: ${now.humidity}%`
      ))
      .addTo(map);
  }

  window.changeStyle = s=>{
    const m = window.map;
    m.setStyle('mapbox://styles/mapbox/'+(s==='satellite'?'satellite-v9':s+'-v11'));
  };

  loadWeather();
</script>
