<!-- ربط Mapbox CSS -->
<link href='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css' rel='stylesheet' />

<!-- حاوية الطقس -->
<div id="weather" style="font-family: Arial, sans-serif; background: #f9f9f9; border-radius: 10px; padding: 20px; width: 300px; margin: 20px auto; text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.1);">
  <h3>الطقس في السويداء الآن</h3>
  <p id="temp">...</p>
  <p id="humidity">...</p>
  <p id="wind">...</p>
  <p id="desc">...</p>
</div>

<!-- حاوية الخريطة -->
<div id='map' style='width: 100%; height: 400px; border-radius: 10px; max-width: 600px; margin: auto;'></div>

<!-- ربط Mapbox JS -->
<script src='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js'></script>

<script>
  const mapboxToken = 'pk.eyJ1Ijoia2FuYXdhdHRvd24iLCJhIjoiY21kdTI2dGl0MDdibjJxc2RhM3NueXZxZCJ9.uO1pbEZoyzPPHp7LOFffBA';  //  Mapbox
  const tomorrowApiKey = 'qtcXEQ29y3U0wLYRWS5cAekT1Bwv4UT8';  //  Tomorrow.io
  const lat = 32.7092;
  const lon = 36.5663;

  const weatherDescriptions = {
    1000: "سماء صافية",
    1100: "غائم جزئيًا",
    1101: "غائم",
    1102: "غائم جدًا",
    2000: "ضباب",
    4000: "مطر خفيف",
    4200: "مطر متوسط",
    4201: "مطر غزير",
    5000: "ثلوج خفيفة",
    6000: "أمطار ثلجية",
    8000: "عاصفة"
  };

  async function getWeatherAndMap() {
    // جلب بيانات الطقس من Tomorrow.io
    try {
      const response = await fetch(`https://api.tomorrow.io/v4/weather/realtime?location=${lat},${lon}&apikey=${tomorrowApiKey}`);
      const data = await response.json();

      if (!data.data || !data.data.values) {
        throw new Error('بيانات الطقس غير متوفرة');
      }

      const values = data.data.values;
      const temp = values.temperature;
      const humidity = values.humidity;
      const wind = values.windSpeed;
      const code = values.weatherCode;

      // عرض بيانات الطقس نصياً
      document.getElementById("temp").textContent = `درجة الحرارة: ${temp}°C`;
      document.getElementById("humidity").textContent = `الرطوبة: ${humidity}%`;
      document.getElementById("wind").textContent = `الرياح: ${wind} كم/س`;
      document.getElementById("desc").textContent = `الحالة: ${weatherDescriptions[code] || "غير معروفة"}`;

      // إنشاء الخريطة باستخدام Mapbox
      mapboxgl.accessToken = mapboxToken;

      const map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/streets-v11',
        center: [lon, lat],  // مركز الخريطة
        zoom: 10
      });

      // إضافة Marker مع بيانات الطقس
      const popup = new mapboxgl.Popup({ offset: 25 }).setText(
        `الطقس: ${weatherDescriptions[code] || "غير معروف"}\nدرجة الحرارة: ${temp}°C\nالرطوبة: ${humidity}%\nالرياح: ${wind} كم/س`
      );

      new mapboxgl.Marker()
        .setLngLat([lon, lat])
        .setPopup(popup)
        .addTo(map);

    } catch (error) {
      console.error('خطأ في جلب بيانات الطقس:', error);
      document.getElementById("weather").innerHTML = "تعذر جلب بيانات الطقس.";
      // ممكن تعرض رسالة على الخريطة أو تخفيها حسب رغبتك
    }
  }

  getWeatherAndMap();
</script>
