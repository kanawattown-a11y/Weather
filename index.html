<!-- Mapbox CSS -->
<link href='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css' rel='stylesheet' />

<!-- حاوية الطقس -->
<div id="weather" style="font-family: Arial, sans-serif; background: #f9f9f9; border-radius: 10px; padding: 20px; width: 300px; margin: 20px auto; text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.1);">
  <h3>الطقس في السويداء الآن</h3>
  <p id="temp">...</p>
  <p id="humidity">...</p>
  <p id="wind">...</p>
  <p id="desc">...</p>
</div>

<!-- أزرار تغيير نوع الخريطة -->
<div id="style-switcher" style="position: absolute; top: 10px; right: 10px; background: white; border-radius: 5px; box-shadow: 0 2px 6px rgba(0,0,0,0.3); padding: 5px; z-index: 10;">
  <button onclick="changeStyle('streets')">شوارع</button>
  <button onclick="changeStyle('satellite')">أقمار صناعية</button>
  <button onclick="changeStyle('outdoors')">تضاريس</button>
</div>

<!-- حاوية الخريطة -->
<div id='map' style='width: 100%; height: 500px; border-radius: 10px; max-width: 800px; margin: 80px auto 40px; position: relative;'></div>

<!-- Mapbox JS -->
<script src='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js'></script>

<script>
  const mapboxToken = 'pk.eyJ1Ijoia2FuYXdhdHRvd24iLCJhIjoiY21kdTI2dGl0MDdibjJxc2RhM3NueXZxZCJ9.uO1pbEZoyzPPHp7LOFffBA';  
  const tomorrowApiKey = 'qtcXEQ29y3U0wLYRWS5cAekT1Bwv4UT8';  
  const lat = 32.7092;
  const lon = 36.5663;

  const weatherDescriptions = {
    1000: "سماء صافية",
    1100: "غائم جزئيًا",
    1101: "غائم",
    1102: "غائم جدًا",
    2000: "ضباب",
    4000: "مطر خفيف",
    4200: "مطر متوسط",
    4201: "مطر غزير",
    5000: "ثلوج خفيفة",
    6000: "أمطار ثلجية",
    8000: "عاصفة"
  };

  async function getWeatherAndMap() {
    try {
      const response = await fetch(`https://api.tomorrow.io/v4/weather/realtime?location=${lat},${lon}&apikey=${tomorrowApiKey}`);
      const data = await response.json();

      if (!data.data || !data.data.values) throw new Error('بيانات الطقس غير متوفرة');

      const values = data.data.values;
      const temp = values.temperature;
      const humidity = values.humidity;
      const wind = values.windSpeed;
      const code = values.weatherCode;

      // عرض بيانات الطقس
      document.getElementById("temp").textContent = `درجة الحرارة: ${temp}°C`;
      document.getElementById("humidity").textContent = `الرطوبة: ${humidity}%`;
      document.getElementById("wind").textContent = `الرياح: ${wind} كم/س`;
      document.getElementById("desc").textContent = `الحالة: ${weatherDescriptions[code] || "غير معروفة"}`;

      // إعداد الخريطة
      mapboxgl.accessToken = mapboxToken;
      window.map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/streets-v11',
        center: [lon, lat],
        zoom: 10
      });

      // أزرار التحكم الافتراضية (تكبير/تصغير)
      map.addControl(new mapboxgl.NavigationControl());

      // زر إعادة الموقع
      class ResetControl {
        onAdd(map) {
          this.map = map;
          this.btn = document.createElement('button');
          this.btn.textContent = '🏠';
          this.btn.title = 'إعادة الموقع';
          this.btn.style.cssText = `
            background: white; 
            border: none; 
            padding: 8px; 
            margin: 10px;
            cursor: pointer;
            font-size: 18px;
            border-radius: 4px;
            box-shadow: 0 0 5px rgba(0,0,0,0.2);
          `;
          this.btn.onclick = () => {
            map.flyTo({center: [lon, lat], zoom: 10});
          };
          const container = document.createElement('div');
          container.className = 'mapboxgl-ctrl mapboxgl-ctrl-group';
          container.appendChild(this.btn);
          return container;
        }
        onRemove() {
          this.btn.parentNode.removeChild(this.btn);
          this.map = undefined;
        }
      }
      map.addControl(new ResetControl(), 'top-left');

      // أضف Marker مع بيانات الطقس
      const popup = new mapboxgl.Popup({ offset: 25 }).setText(
        `الطقس: ${weatherDescriptions[code] || "غير معروف"}\nدرجة الحرارة: ${temp}°C\nالرطوبة: ${humidity}%\nالرياح: ${wind} كم/س`
      );

      new mapboxgl.Marker()
        .setLngLat([lon, lat])
        .setPopup(popup)
        .addTo(map);

      // السماح للمستخدم بإضافة علامات عند النقر
      map.on('click', (e) => {
        new mapboxgl.Marker()
          .setLngLat(e.lngLat)
          .setPopup(new mapboxgl.Popup().setText(`الإحداثيات:\n${e.lngLat.lat.toFixed(4)}, ${e.lngLat.lng.toFixed(4)}`))
          .addTo(map);
      });

      // تغيير نمط الخريطة بناءً على اختيار المستخدم
      window.changeStyle = function(style) {
        const styleMap = {
          streets: 'mapbox://styles/mapbox/streets-v11',
          satellite: 'mapbox://styles/mapbox/satellite-v9',
          outdoors: 'mapbox://styles/mapbox/outdoors-v12'
        };
        map.setStyle(styleMap[style]);
      };

    } catch (error) {
      console.error('خطأ في جلب بيانات الطقس:', error);
      document.getElementById("weather").innerHTML = "تعذر جلب بيانات الطقس.";
    }
  }

  getWeatherAndMap();
</script>
